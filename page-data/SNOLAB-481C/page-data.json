{"componentChunkName":"component---src-templates-post-js","path":"/SNOLAB-481C","result":{"data":{"markdownRemark":{"html":"<p>背景：Windows 服务器，雪星需要用 SFTP 将代码向其同步，即需对其进行 SSH 服务器的安装，并使密钥文件访问打通。</p>\n<h2 id=\"一、结论：快速配置代码\"><a href=\"#%E4%B8%80%E3%80%81%E7%BB%93%E8%AE%BA%EF%BC%9A%E5%BF%AB%E9%80%9F%E9%85%8D%E7%BD%AE%E4%BB%A3%E7%A0%81\" aria-label=\"一、结论：快速配置代码 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>一、结论：快速配置代码</h2>\n<p>环境简述：\n控制端A：可以是 Windows 或 Linux\n受控端B：Windows 10，准备安装 OpenSSH Server</p>\n<h3 id=\"1-受控端b-安装安装-openssh-server\"><a href=\"#1-%E5%8F%97%E6%8E%A7%E7%AB%AFb-%E5%AE%89%E8%A3%85%E5%AE%89%E8%A3%85-openssh-server\" aria-label=\"1 受控端b 安装安装 openssh server permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. 受控端B 安装安装 OpenSSH Server</h3>\n<p>在受控端上 按 Win + X A 打开管理员权限的 Powershell窗口，执行：</p>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\"><span class=\"token comment\"># 检查SSH安装情况</span>\nGet<span class=\"token operator\">-</span>WindowsCapability <span class=\"token operator\">-</span>Online <span class=\"token punctuation\">|</span> ? Name <span class=\"token operator\">-like</span> <span class=\"token string\">'OpenSSH*'</span>\n\n<span class=\"token comment\"># 期望输出如下</span>\n<span class=\"token comment\"># Name  : OpenSSH.Client~~~~0.0.1.0</span>\n<span class=\"token comment\"># State : NotPresent</span>\n<span class=\"token comment\"># Name  : OpenSSH.Server~~~~0.0.1.0</span>\n<span class=\"token comment\"># State : NotPresent</span>\n\n<span class=\"token comment\"># 安装 OpenSSH Client</span>\nAdd<span class=\"token operator\">-</span>WindowsCapability <span class=\"token operator\">-</span>Online <span class=\"token operator\">-</span>Name OpenSSH<span class=\"token punctuation\">.</span>Client~~~~0<span class=\"token punctuation\">.</span>0<span class=\"token punctuation\">.</span>1<span class=\"token punctuation\">.</span>0\n\n<span class=\"token comment\"># 安装 OpenSSH Server</span>\nAdd<span class=\"token operator\">-</span>WindowsCapability <span class=\"token operator\">-</span>Online <span class=\"token operator\">-</span>Name OpenSSH<span class=\"token punctuation\">.</span>Server~~~~0<span class=\"token punctuation\">.</span>0<span class=\"token punctuation\">.</span>1<span class=\"token punctuation\">.</span>0\n\n<span class=\"token comment\"># 两条命例期望输出如下</span>\n<span class=\"token comment\"># Path          :</span>\n<span class=\"token comment\"># Online        : True</span>\n<span class=\"token comment\"># RestartNeeded : False</span>\n\n<span class=\"token comment\"># 打开 OpenSSH Server 配置文件</span>\nnotepad <span class=\"token string\">\"C:\\ProgramData\\ssh\\sshd_config\"</span>\n\n<span class=\"token comment\"># 找到文件最后这2行，把它们注释掉，像这样：</span>\n<span class=\"token comment\"># Match Group administrators</span>\n<span class=\"token comment\">#       AuthorizedKeysFile __PROGRAMDATA__/ssh/administrators_authorized_keys</span></code></pre></div>\n<h3 id=\"2-本机生成密钥并将公钥送与受控端认证\"><a href=\"#2-%E6%9C%AC%E6%9C%BA%E7%94%9F%E6%88%90%E5%AF%86%E9%92%A5%E5%B9%B6%E5%B0%86%E5%85%AC%E9%92%A5%E9%80%81%E4%B8%8E%E5%8F%97%E6%8E%A7%E7%AB%AF%E8%AE%A4%E8%AF%81\" aria-label=\"2 本机生成密钥并将公钥送与受控端认证 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. 本机生成密钥并将公钥送与受控端认证</h3>\n<p>在本机用户文件夹，执行：</p>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\"><span class=\"token comment\"># 如果你还没有密钥或不知道密钥是啥的话，就先生成一对密钥好了</span>\nssh<span class=\"token operator\">-</span>keygen</code></pre></div>\n<p>然后把公钥扔到受控端上，也就是 控制端: <code class=\"language-text\">~/.ssh/id_rsa.pub</code> 变成 受控端: <code class=\"language-text\">~/.ssh/authorized_keys</code> 即可。这里因为指令集不一样所以 <code class=\"language-text\">ssh-copy-id</code> 无效，就只好手动复制一下了。即执行指令：</p>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\">scp <span class=\"token punctuation\">.</span>ssh\\id_rsa<span class=\"token punctuation\">.</span>pub user@host:<span class=\"token punctuation\">.</span>ssh\\authorized_keys2</code></pre></div>\n<p>至此完成了配置，再尝试进行 ssh 连接就可以无密码连上去了。</p>\n<h3 id=\"3\"><a href=\"#3\" aria-label=\"3 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3.</h3>\n<p>SFTP的配置，以 vscode 工程为例\n<code class=\"language-text\">.vscode/sftp.config</code></p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"user@hsot\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"host\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"host\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"protocol\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"sftp\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"port\"</span><span class=\"token operator\">:</span> <span class=\"token number\">22</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"username\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"user\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"privateKeyPath\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"~/.ssh/id_rsa\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"remotePath\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"C:/Users/user/Desktop/SIT-VPN-SERVICE\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"uploadOnSave\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2 id=\"二、为什么？\"><a href=\"#%E4%BA%8C%E3%80%81%E4%B8%BA%E4%BB%80%E4%B9%88%EF%BC%9F\" aria-label=\"二、为什么？ permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>二、为什么？</h2>\n<p>路径问题：\nLinux 下的 sshd 通常会采用 ~/.ssh/authorized_keys 来认证传入 sshd 的连接。</p>\n<p>而 Windows 下似乎 OpenSSH Server 并不运行在普通用户权限下，于是 AuthorizedKeysFile 也就自然而然的没有放到用户的文件夹里。</p>\n<p>找到 OpenSSH Server 的配置文件文件，便得知了这一点。</p>\n<p><code class=\"language-text\">C:\\ProgramData\\ssh\\sshd_config</code></p>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\"><span class=\"token comment\"># This is the sshd server system-wide configuration file.  See</span>\n<span class=\"token comment\"># sshd_config(5) for more information.</span>\n\n<span class=\"token comment\"># ………省略N多行</span>\n\nMatch <span class=\"token function\">Group</span> administrators\n       AuthorizedKeysFile __PROGRAMDATA__<span class=\"token operator\">/</span>ssh<span class=\"token operator\">/</span>administrators_authorized_keys</code></pre></div>\n<p>也就是在默认情况下 Windows 安装的 OpenSSH Server 的认证文件路径被放在了这里： <code class=\"language-text\">C:\\ProgramData\\ssh\\administrators_authorized_keys</code>。\n要解决这个问题，比较简单的方案是直接把后面这 2 行配置去掉然后它就会选择回我们比较习惯的用户目录下的 <code class=\"language-text\">.ssh/authorized_keys</code>。</p>\n<p>或者如果你想按它的默认路径放置的话（即 <code class=\"language-text\">__PROGRAMDATA__/ssh/administrators_authorized_keys</code>），\n那么还需要修正一下你放上去的 <code class=\"language-text\">administrators_authorized_keys</code> 的权限。这个方案的权限的问题雪得猜测是来源于 ProgramData 是个系统管理的文件夹，普通进程需要申请权限才能读写，</p>\n<p>即修复方法如下：在受控端上 按 Win + X A 打开管理员权限的 Powershell窗口，执行：</p>\n<div class=\"gatsby-highlight\" data-language=\"powershell\"><pre class=\"language-powershell\"><code class=\"language-powershell\"><span class=\"token comment\"># 执行以下代码修正 icacls administrators_authorized_keys 的文件权限，并重启 sshd</span>\ncd C:\\ProgramData\\ssh\nicacls administrators_authorized_keys <span class=\"token operator\">/</span>inheritance:r\nicacls administrators_authorized_keys <span class=\"token operator\">/</span>grant SYSTEM:`<span class=\"token punctuation\">(</span>F`<span class=\"token punctuation\">)</span>\nicacls administrators_authorized_keys <span class=\"token operator\">/</span>grant BUILTIN\\Administrators:`<span class=\"token punctuation\">(</span>F`<span class=\"token punctuation\">)</span>\nnet stop sshd\nnet <span class=\"token function\">start</span> sshd</code></pre></div>\n<h2 id=\"三、参考文献\"><a href=\"#%E4%B8%89%E3%80%81%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE\" aria-label=\"三、参考文献 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>三、参考文献</h2>\n<ol>\n<li><a href=\"https://docs.microsoft.com/ja-jp/windows-server/administration/openssh/openssh_install_firstuse\">Windows Server 2019 および Windows 10 用 OpenSSH のインストール</a></li>\n<li><a href=\"https://serverfault.com/questions/873064/public-key-authentication-windows-port-of-openssh\">ssh - Public Key Authentication Windows Port of OpenSSH - Server Fault</a></li>\n</ol>","timeToRead":4,"excerpt":"背景：Windows 服务器，雪星需要用 SFTP 将代码向其同步，即需对其进行 SSH 服务器的安装，并使密钥文件访问打通。 一、结论：快速配置代码 环境简述：\n控制端A：可以是 Windows 或 Linux\n受控端B：Windows 10，准备安装 OpenSSH…","tableOfContents":"<ul>\n<li>\n<p><a href=\"/SNOLAB-481C/#%E4%B8%80%E3%80%81%E7%BB%93%E8%AE%BA%EF%BC%9A%E5%BF%AB%E9%80%9F%E9%85%8D%E7%BD%AE%E4%BB%A3%E7%A0%81\">一、结论：快速配置代码</a></p>\n<ul>\n<li><a href=\"/SNOLAB-481C/#1-%E5%8F%97%E6%8E%A7%E7%AB%AFb-%E5%AE%89%E8%A3%85%E5%AE%89%E8%A3%85-openssh-server\">1. 受控端B 安装安装 OpenSSH Server</a></li>\n<li><a href=\"/SNOLAB-481C/#2-%E6%9C%AC%E6%9C%BA%E7%94%9F%E6%88%90%E5%AF%86%E9%92%A5%E5%B9%B6%E5%B0%86%E5%85%AC%E9%92%A5%E9%80%81%E4%B8%8E%E5%8F%97%E6%8E%A7%E7%AB%AF%E8%AE%A4%E8%AF%81\">2. 本机生成密钥并将公钥送与受控端认证</a></li>\n<li><a href=\"/SNOLAB-481C/#3\">3.</a></li>\n</ul>\n</li>\n<li><a href=\"/SNOLAB-481C/#%E4%BA%8C%E3%80%81%E4%B8%BA%E4%BB%80%E4%B9%88%EF%BC%9F\">二、为什么？</a></li>\n<li><a href=\"/SNOLAB-481C/#%E4%B8%89%E3%80%81%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE\">三、参考文献</a></li>\n</ul>","frontmatter":{"title":"Windows 启用 OpenSSH Server 及无密码登录操作笔记","cover":"","date":"2020-07-17T00:00:00.000Z","categories":["运维"],"tags":["Windows","运维"]},"fields":{"slug":"/SNOLAB-481C","date":"July 16, 2020"}}},"pageContext":{"slug":"/SNOLAB-481C","nexttitle":"雪星实验室？","nextslug":"/SNOLAB-480C","prevtitle":"Mathematica 批量缩放图片","prevslug":"/SNOLAB-4260"}}}